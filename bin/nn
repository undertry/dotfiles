#!/run/current-system/sw/bin/bash

BASE_DIR="$HOME/Documents/Notes"
DATE=$(date +%Y-%m-%d)
TIME=$(date +%H-%M)
DATETIME="${DATE}_${TIME}"

# MenÃº de selecciÃ³n de tipo con iconos
echo "ğŸ“˜ Â¿QuÃ© tipo de nota querÃ©s crear?"
echo "1) ğŸ›  project"
echo "2) ğŸ“š study"
echo "3) ğŸ““ journal"
read -rp "ElegÃ­ una opciÃ³n [1-3]: " type_choice

case $type_choice in
  1) tipo="project" ;;
  2) tipo="study" ;;
  3) tipo="journal" ;;
  *) echo "âŒ OpciÃ³n invÃ¡lida"; exit 1 ;;
esac

# ğŸ“ SelecciÃ³n de carpeta para study o project
if [[ $tipo == "study" || $tipo == "project" ]]; then
  echo "ğŸ“‚ CategorÃ­as disponibles en '$tipo':"
  subfolders=($(find "$BASE_DIR/$tipo" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; 2>/dev/null))

  if [ ${#subfolders[@]} -eq 0 ]; then
    echo "ğŸ†• No hay subcarpetas creadas aÃºn."
    read -rp "ğŸ“ IngresÃ¡ el nombre de la nueva categorÃ­a: " subdir
  else
    select folder in "${subfolders[@]}" "â• Crear nueva categorÃ­a"; do
      if [[ $folder == "â• Crear nueva categorÃ­a" ]]; then
        read -rp "ğŸ“ Nombre de la nueva categorÃ­a: " subdir
        break
      elif [[ -n $folder ]]; then
        subdir="$folder"
        break
      else
        echo "âŒ OpciÃ³n invÃ¡lida"
      fi
    done
  fi
  DIR="$BASE_DIR/$tipo/$subdir"
  mkdir -p "$DIR"
fi

# ğŸ· Tags (excepto para journal)
if [[ $tipo != "journal" ]]; then
  read -rp "ğŸ· Tags (separados por espacio): " tags_input
  tags=$(echo "$tags_input" | tr ' ' ', ')
fi

# ğŸ“„ TÃ­tulo y nombre del archivo
if [[ $tipo == "journal" ]]; then
  titulo="$DATETIME"
  DIR="$BASE_DIR/journal"
  mkdir -p "$DIR"
  FILENAME="$DIR/$DATETIME.md"
else
  read -rp "ğŸ“„ TÃ­tulo de la nota: " titulo
  slug=$(echo "$titulo" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')
  FILENAME="$DIR/$slug.md"
fi

# ğŸ§© Plantillas
case $tipo in
  project)
    template=$'\n# Objetivo\n\n# Progreso\n\n# Tareas\n- [ ] Primera tarea'
    ;;
  study)
    template=$'\n# Resumen\n\n# Conceptos clave\n\n# Notas adicionales'
    ;;
  journal)
    template=$'\n# Reflexiones del dÃ­a\n\n# QuÃ© aprendÃ­\n\n# CÃ³mo me sentÃ­'
    ;;
esac

# ğŸ“„ Contenido del archivo
{
  echo "---"
  echo "title: \"$titulo\""
  echo "type: $tipo"
  echo "status: In progress"
  echo "start_date: \"$DATE\""
  # Para journal, no se pone end_date
  [[ $tipo != "journal" ]] && echo "end_date: \"\""
  [[ $tipo != "journal" ]] && echo "tags: [$tags]"
  echo "---"
  echo ""
  echo "# $titulo"
  echo "$template"
} > "$FILENAME"

echo "âœ… Nota creada en: $FILENAME"
hx "$FILENAME"

# Para study y project, preguntar si se finalizÃ³ la nota
if [[ $tipo != "journal" ]]; then
  read -rp "ğŸŸ¢ Â¿Finalizaste esta nota? [s/n]: " FINISH
  if [[ $FINISH =~ ^[sS]$ ]]; then
    end_date=$(date +%Y-%m-%d)
    sed -i "s/status: In progress/status: Finished/" "$FILENAME"
    sed -i "s/end_date: \"\"/end_date: \"$end_date\"/" "$FILENAME"
  fi
fi

# ğŸ‘€ VisualizaciÃ³n
echo "ğŸ‘€ Â¿QuerÃ©s visualizar la nota?"
select view_opt in "No" "Glow" "Grip" "Pandoc"; do
  case $view_opt in
    No) break ;;
    Glow) glow "$FILENAME"; break ;;
    Grip) grip "$FILENAME"; break ;;
    Pandoc)
      HTML_FILE="${FILENAME%.md}.html"
      pandoc "$FILENAME" -s -o "$HTML_FILE"
      live-server --quiet "$(dirname "$HTML_FILE")" &
      SERVER_PID=$!
      sleep 1  # Espera a que live-server inicie
      URL="http://127.0.0.1:8080/$(basename "$HTML_FILE")"
      xdg-open "$URL"
      echo "PresionÃ¡ Enter cuando termines de visualizar la nota..."
      read -r
      kill "$SERVER_PID" 2>/dev/null
      read -rp "ğŸ—‘ Â¿Borrar el HTML generado? (s/n): " borrar
      [[ $borrar == [sS] ]] && rm "$HTML_FILE"
      break
      ;;
    *) echo "âŒ OpciÃ³n invÃ¡lida" ;;
  esac
done
